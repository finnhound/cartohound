<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family:'Inter', sans-serif; overflow: hidden; background: #000; }
.map { 
    width:100%; 
    height:100%; 
    position:absolute; 
    top:0; 
    left:0; 
    transition: transform 0.3s ease;
    /* Optimization: prevent unnecessary browser repaints */
    will-change: transform;
    contain: strict;
}

#pan-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; display: none; pointer-events: auto; }
#loading-bar { position: fixed; top: 0; left: 0; width: 0%; height: 6px; background: linear-gradient(90deg, #007aff, #5856d6); z-index: 200; transition: width 0.3s, opacity 0.3s; box-shadow: 0 2px 8px rgba(0,122,255,0.4); }

/* PC UI: Top-Middle Pill */
#controls { 
    position:absolute; top:20px; left:50%; transform: translateX(-50%); 
    z-index:25; background:white; padding:10px 16px; border:1px solid #ccc; 
    display:flex; flex-direction:row; align-items: center; gap:12px; 
    border-radius:30px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

#searchBox { width:200px; padding:8px 12px; border-radius:6px; border:1px solid #ddd; font-size: 14px; }
#searchResults { 
    position:absolute; top:55px; left:0; background:white; border:1px solid #ddd; 
    max-height:200px; overflow-y:auto; width:100%; z-index:100; border-radius:8px; display:none;
}
.searchItem { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }

.route-info { 
    position:absolute; top: 90px; left: 50%; transform: translateX(-50%); 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
    padding: 10px 20px; font: bold 14px 'Inter', sans-serif; z-index: 24; 
    border-radius: 25px; display: none; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* PC Side Buttons */
#downloadMap, #gpsToggle, #hybridToggle { 
    position:absolute; right:20px; z-index:20; background:white; border:1px solid #ccc; 
    cursor:pointer; border-radius:10px; width:44px; height:44px; display:flex; 
    align-items:center; justify-content:center;
}
#downloadMap { top:20px; } #gpsToggle { top:75px; } #hybridToggle { top:130px; }
#gpsToggle.active { background: #007aff; } #gpsToggle.active svg { stroke: white; }

#routeFromLocation {
    position: absolute; top: 185px; right: 20px; z-index: 20; background: #00c7be;
    color: white; border: none; padding: 10px 16px; border-radius: 20px;
    font-size: 13px; font-weight: 600; cursor: pointer; display: none;
}

/* MOBILE ONLY SCALING (PORTRAIT) */
@media screen and (orientation: portrait) {
    #map-streets, #map-hybrid { 
        width: 45.45%; height: 45.45%; 
        transform: scale(2.2); transform-origin: top left;
    }
    
    #controls { 
        position: fixed; flex-direction: column; width: 180px;
        top: 15px; right: 15px; left: auto;
        transform: scale(1.6); transform-origin: top right;
    }
    
    .route-info { 
        position: fixed; top: 20px; left: 20px; right: auto;
        transform: scale(1.5); transform-origin: top left;
        max-width: 40%; font-size: 13px;
    }
    
    /* STAYS THE SAME SIZE (No Scale) */
    #routeFromLocation {
        position: fixed; bottom: 150px; right: 20px; top: auto;
        display: none; z-index: 100; transform: none; 
        padding: 12px 20px; font-size: 14px;
    }

    #downloadMap { bottom: 330px; top: auto; transform: scale(1.6); transform-origin: right center; }
    #gpsToggle { bottom: 260px; top: auto; transform: scale(1.6); transform-origin: right center; }
    #hybridToggle { bottom: 190px; top: auto; transform: scale(1.6); transform-origin: right center; }
    
    .maplibregl-ctrl-group { display: none !important; }
    .maptiler-logo { bottom: 60px; left: 15px; transform: scale(1.2); transform-origin: bottom left; }
    .attribution-text { bottom: 10px; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; }
}
</style>
</head>
<body>

<div id="loading-bar"></div>
<div id="pan-blocker"></div>
<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search"/>
  <div id="searchResults"></div>
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walk</option>
    <option value="cycling-regular">Cycle</option>
  </select>
  <button id="resetRoute">Reset</button>
</div>

<div id="downloadMap">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5856d6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/></svg>
</div>

<div id="gpsToggle">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
</div>

<div id="hybridToggle"><img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" width="24" height="24"></div>

<button id="routeFromLocation">üìç Route from Location</button>
<div id="route-info" class="route-info"></div>

<div class="attribution-text" style="position:absolute; bottom:10px; right:10px; z-index:25; color:white; font-size:10px;">
    ¬© OpenStreetMap | ¬© MapTiler
</div>

<script>
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFjMzkyNDVlOGIyNjQxYjVhMDRhNWEwNjdlMTM4MDc0IiwiaCI6Im11cm11cjY0In0=";
const MT_KEY = 'kUOJqqeRX1BMaXctsgK5';
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const isMobile = window.innerHeight > window.innerWidth;
const MAP_SCALE = isMobile ? 2.2 : 1.0;

let currentStyle = 'streets';
let routingEnabled = false;
let routePoints = [];
let startMarker = null, endMarker = null, waypointMarkers = [];
let currentCoords = null;
let watchId = null;

const mapOptions = {
    center: [0,0], zoom: 2, attributionControl: false,
    preserveDrawingBuffer: true, antialias: false, // Performance boost
};

const mapStreets = new maplibregl.Map({ container: 'map-streets', style: STREETS_URL, ...mapOptions });
const mapHybrid = new maplibregl.Map({ container: 'map-hybrid', style: HYBRID_URL, ...mapOptions });

function setLoading(active) {
    document.getElementById('loading-bar').style.width = active ? '70%' : '100%';
    document.getElementById('loading-bar').style.opacity = active ? '1' : '0';
}

// FIX: PC Location Fetching
const getLocation = () => {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true, timeout: 5000, maximumAge: 0
        });
    });
};

document.getElementById('gpsToggle').onclick = async () => {
    setLoading(true);
    try {
        const pos = await getLocation();
        currentCoords = [pos.coords.longitude, pos.coords.latitude];
        const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
        activeMap.flyTo({ center: currentCoords, zoom: 15 });
        document.getElementById('gpsToggle').classList.add('active');
        if (routingEnabled) {
            document.getElementById('routeFromLocation').style.display = 'block';
        }
    } catch (err) {
        alert("Location error. Please check permissions.");
    }
    setLoading(false);
};

// FIX: Broken Mobile Routing (Coordinate Math Correction)
// When the map is CSS-scaled, we must divide the click coordinates by the scale factor
const handleMapClick = (e) => {
    if (!routingEnabled) return;

    // The logic: MapLibre thinks the map is 100% wide. 
    // Browsers report e.point based on the VISUAL (scaled) size.
    // We must project the click correctly.
    const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
    
    // If mobile, we use the raw lngLat which MapLibre handles better than 'point' during CSS transforms
    const coords = [e.lngLat.lng, e.lngLat.lat];
    
    if (!startMarker || !endMarker) {
        addPin(coords);
    } else {
        // Waypoint logic
        addWaypoint(coords);
    }
};

mapStreets.on('click', handleMapClick);
mapHybrid.on('click', handleMapClick);

function addPin(lngLat) {
    const activeMap = currentStyle === 'streets' ? mapStreets : mapHybrid;
    const type = !startMarker ? 'start' : 'end';
    
    const el = document.createElement('div');
    el.style.width = '40px'; el.style.height = '40px';
    el.innerHTML = `<svg viewBox="0 0 24 24" fill="${type === 'start' ? '#00c7be' : '#ff9500'}" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="8"/></svg>`;
    
    const m = new maplibregl.Marker({ element: el, draggable: true }).setLngLat(lngLat).addTo(activeMap);
    
    if (type === 'start') {
        startMarker = m;
        routePoints[0] = lngLat;
    } else {
        endMarker = m;
        routePoints[1] = lngLat;
        fetchRoute();
    }

    m.on('dragend', () => {
        const newPos = [m.getLngLat().lng, m.getLngLat().lat];
        if (m === startMarker) routePoints[0] = newPos;
        else routePoints[routePoints.length - 1] = newPos;
        fetchRoute();
    });
}

function fetchRoute() {
    if (routePoints.length < 2) return;
    setLoading(true);
    fetch(`https://api.openrouteservice.org/v2/directions/${document.getElementById('mode').value}/geojson`, {
        method: 'POST',
        headers: { "Authorization": ORS_KEY, "Content-Type": "application/json" },
        body: JSON.stringify({ coordinates: routePoints })
    }).then(res => res.json()).then(data => {
        setLoading(false);
        const feat = data.features[0];
        document.getElementById('route-info').innerHTML = `${(feat.properties.summary.distance/1000).toFixed(1)}km | ${Math.round(feat.properties.summary.duration/60)}m`;
        document.getElementById('route-info').style.display = 'block';

        [mapStreets, mapHybrid].forEach(m => {
            if (m.getSource('route')) m.removeLayer('route'), m.removeSource('route');
            m.addSource('route', { type: 'geojson', data: feat.geometry });
            m.addLayer({ id: 'route', type: 'line', source: 'route', paint: { 'line-color': '#0074d9', 'line-width': 6 } });
        });
    });
}

// FIX: Sluggishness - Throttled Syncing
let isSyncing = false;
const sync = (src, dest) => {
    if (isSyncing) return;
    isSyncing = true;
    dest.jumpTo({ center: src.getCenter(), zoom: src.getZoom(), bearing: src.getBearing() });
    requestAnimationFrame(() => isSyncing = false);
};

mapStreets.on('move', () => sync(mapStreets, mapHybrid));
mapHybrid.on('move', () => sync(mapHybrid, mapStreets));

document.getElementById('toggleRoute').onclick = function() {
    routingEnabled = !routingEnabled;
    this.style.background = routingEnabled ? '#ff3b30' : 'white';
    this.style.color = routingEnabled ? 'white' : 'black';
    if (!routingEnabled) resetRoute();
};

function resetRoute() {
    if (startMarker) startMarker.remove();
    if (endMarker) endMarker.remove();
    waypointMarkers.forEach(w => w.remove());
    routePoints = []; startMarker = null; endMarker = null; waypointMarkers = [];
    document.getElementById('route-info').style.display = 'none';
}

document.getElementById('resetRoute').onclick = resetRoute;

document.getElementById('hybridToggle').onclick = () => {
    currentStyle = currentStyle === 'streets' ? 'hybrid' : 'streets';
    document.getElementById('map-streets').style.display = currentStyle === 'streets' ? 'block' : 'none';
    document.getElementById('map-hybrid').style.display = currentStyle === 'hybrid' ? 'block' : 'none';
};

document.getElementById('routeFromLocation').onclick = () => {
    if (currentCoords) {
        resetRoute();
        addPin(currentCoords);
        document.getElementById('routeFromLocation').style.display = 'none';
    }
};
</script>
</body>
</html>
