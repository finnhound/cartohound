<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; font-family:'Inter', sans-serif; }
.map { width:100%; height:100%; position:absolute; top:0; left:0; }

#controls { position:absolute; top:10px; right:10px; z-index:25; background:white; padding:10px; border:1px solid #ccc; display:flex; flex-direction:column; gap:5px; border-radius:6px; }
#hybridToggle { position:absolute; top:180px; right:10px; z-index:20; background:white; padding:8px; border:1px solid #ccc; cursor:pointer; border-radius:6px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
#hybridToggle.active { background:#ddd; }

#downloadMap { position:absolute; top:130px; right:10px; z-index:20; background:white; padding:8px; border-radius:6px; border:1px solid #ccc; cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }

#searchBox { width:200px; padding:4px; border-radius:4px; border:1px solid #ccc; }
#searchResults { position:absolute; top:38px; right:10px; background:white; border:1px solid #ccc; max-height:180px; overflow-y:auto; width:200px; display:none; z-index:30; }

.searchItem { padding:4px 6px; cursor:pointer; }
.searchItem:hover { background:#eee; }
</style>
</head>

<body>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <input id="searchBox" placeholder="Search">
  <div id="searchResults"></div>
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walking</option>
    <option value="cycling-regular">Cycling</option>
  </select>
  <button id="resetRoute">Reset Route</button>
</div>

<div id="downloadMap"></div>
<div id="hybridToggle"></div>

<div id="route-info" style="display:none"></div>

<script>
const ORS_KEY = "YOUR_KEY";
const MT_KEY = "YOUR_KEY";

const STREETS_URL = `https://api.maptiler.com/maps/streets/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

let currentStyle = 'streets';
let routingEnabled = false;
let routingMode = 'driving-car';

let routePoints = [];
let startMarker = null;
let endMarker = null;
let waypointMarkers = [];

const mapStreets = new maplibregl.Map({
  container:'map-streets',
  style:STREETS_URL,
  center:[0,0],
  zoom:2,
  preserveDrawingBuffer:true
});

const mapHybrid = new maplibregl.Map({
  container:'map-hybrid',
  style:HYBRID_URL,
  center:[0,0],
  zoom:2,
  preserveDrawingBuffer:true
});

function activeMap() {
  return currentStyle === 'streets' ? mapStreets : mapHybrid;
}

/* ---------------- ROUTING CORE ---------------- */

function clearRoute() {
  if (startMarker) startMarker.remove();
  if (endMarker) endMarker.remove();

  waypointMarkers.forEach(wp => {
    wp.streets.remove();
    wp.hybrid.remove();
  });

  startMarker = null;
  endMarker = null;
  waypointMarkers = [];
  routePoints = [];

  [mapStreets, mapHybrid].forEach(m => {
    if (m.getSource('route')) {
      m.removeLayer('route');
      m.removeSource('route');
    }
  });
}

function fetchRoute() {
  if (routePoints.length < 2) return;

  fetch(`https://api.openrouteservice.org/v2/directions/${routingMode}/geojson`, {
    method:'POST',
    headers:{
      'Authorization': ORS_KEY,
      'Content-Type':'application/json'
    },
    body: JSON.stringify({ coordinates: routePoints })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.features) return;

    [mapStreets, mapHybrid].forEach(m => {
      if (m.getSource('route')) {
        m.removeLayer('route');
        m.removeSource('route');
      }
      m.addSource('route', { type:'geojson', data:data.features[0] });
      m.addLayer({
        id:'route',
        type:'line',
        source:'route',
        paint:{ 'line-width':5, 'line-color':'#0074d9' }
      });
    });
  });
}

/* ---------------- WAYPOINTS ---------------- */

function addWaypoint(lngLat) {
  if (!routingEnabled || !startMarker || !endMarker) return;

  const el = document.createElement('div');
  el.style.width = '14px';
  el.style.height = '14px';
  el.style.background = '#5856d6';
  el.style.borderRadius = '50%';

  const s = new maplibregl.Marker({ element: el.cloneNode(true), draggable:true })
    .setLngLat(lngLat).addTo(mapStreets);

  const h = new maplibregl.Marker({ element: el.cloneNode(true), draggable:true })
    .setLngLat(lngLat).addTo(mapHybrid);

  const wp = { streets:s, hybrid:h };
  waypointMarkers.push(wp);

  routePoints.splice(routePoints.length - 1, 0, lngLat);

  s.on('dragend', sync);
  h.on('dragend', sync);

  function sync() {
    const i = waypointMarkers.indexOf(wp);
    if (i === -1) return;
    const p = [s.getLngLat().lng, s.getLngLat().lat];
    routePoints[i + 1] = p;
    h.setLngLat(p);
    fetchRoute();
  }

  fetchRoute();
}

/* ---------------- MAP CLICK ---------------- */

function onMapClick(e) {
  if (!routingEnabled) return;

  if (e.originalEvent.shiftKey && startMarker && endMarker) {
    addWaypoint([e.lngLat.lng, e.lngLat.lat]);
    return;
  }

  const m = new maplibregl.Marker({ draggable:true })
    .setLngLat(e.lngLat)
    .addTo(activeMap());

  if (!startMarker) {
    startMarker = m;
    routePoints[0] = [e.lngLat.lng, e.lngLat.lat];
  } else {
    if (endMarker) endMarker.remove();
    endMarker = m;
    routePoints[routePoints.length - 1] = [e.lngLat.lng, e.lngLat.lat];
  }

  m.on('dragend', () => {
    const i = m === startMarker ? 0 : routePoints.length - 1;
    routePoints[i] = [m.getLngLat().lng, m.getLngLat().lat];
    fetchRoute();
  });

  fetchRoute();
}

mapStreets.on('click', onMapClick);
mapHybrid.on('click', onMapClick);
</script>

</body>
</html>
