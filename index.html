<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<style>
html, body { margin:0; padding:0; height:100%; font-family:'Inter', sans-serif;}
.map { position:absolute; top:0; left:0; width:100%; height:100%; }
#controls {
  position:absolute; top:10px; right:10px; z-index:20;
  background:white; padding:10px; border-radius:6px; border:1px solid #ccc;
  display:flex; flex-direction:column; gap:5px;
}
#hybridToggle {
  position:absolute; top:130px; right:10px; z-index:20;
  width:40px; height:40px; border:1px solid #ccc; border-radius:6px;
  display:flex; justify-content:center; align-items:center; cursor:pointer;
  background:white; transition:0.2s;
}
#hybridToggle.active { background:#ddd; }
#hybridToggle img { width:24px; height:24px; }

#searchBox {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  z-index:25; width:300px; display:flex; flex-direction:column;
}
#searchInput {
  padding:6px 8px; border:1px solid #ccc; border-radius:6px; width:100%;
  box-sizing:border-box;
}
#searchResults {
  background:white; border:1px solid #ccc; border-radius:6px; margin-top:2px;
  max-height:200px; overflow-y:auto; display:none;
}
.route-info {
  position:absolute; top:50px; left:50%; transform:translateX(-50%);
  background:white; padding:8px 14px; border-radius:6px; border:1px solid #333;
  font-size:14px; opacity:0.9; pointer-events:none; z-index:20;
}
.attribution-text {
  position:absolute; bottom:10px; right:10px; z-index:20;
  background:rgba(255,255,255,0.85); padding:6px 10px; border-radius:6px; font-size:12px;
}
.maptiler-logo { position:absolute; left:10px; bottom:10px; z-index:25; }
</style>
</head>
<body>

<div id="map-streets" class="map"></div>
<div id="map-hybrid" class="map" style="display:none;"></div>

<div id="controls">
  <button id="toggleRoute">Enable Routing</button>
  <select id="mode">
    <option value="driving-car">Car</option>
    <option value="foot-walking">Walking</option>
    <option value="cycling-regular">Cycling</option>
  </select>
  <button id="resetRoute">Reset Route</button>
  <button id="locateBtn">Use My Location</button>
</div>

<div id="hybridToggle">
  <img src="https://raw.githubusercontent.com/finnhound/cartohound/7b3c8e14c393450a26d9d562c99016afad43d83a/stack%20(1).svg" alt="Hybrid">
</div>

<div id="searchBox">
  <input type="text" id="searchInput" placeholder="Search for a place...">
  <div id="searchResults"></div>
</div>

<div id="route-info" class="route-info" style="display:none;"></div>

<div class="attribution-text">
  © openrouteservice.org by HeiGIT | Map data © OpenStreetMap contributors | Tiles © MapTiler
</div>
<a class="maptiler-logo" href="https://www.maptiler.com" target="_blank" rel="noopener">
  <img src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo">
</a>

<script>
const ORS_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFjMzkyNDVlOGIyNjQxYjVhMDRhNWEwNjdlMTM4MDc0IiwiaCI6Im11cm11cjY0In0=";
const MT_KEY = 'kUOJqqeRX1BMaXctsgK5';
const STREETS_URL = `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${MT_KEY}`;
const HYBRID_URL = `https://api.maptiler.com/maps/hybrid/style.json?key=${MT_KEY}`;

const savedView = JSON.parse(localStorage.getItem('mapView')||'null');
let currentStyle = localStorage.getItem('mapStyle')||'streets';
let routingEnabled = JSON.parse(localStorage.getItem('mapRouteEnabled')||'false');
let routingMode = document.getElementById('mode').value;

let routePoints = [];
let markers = [];
let searchMarkers = [];
const routeInfo = document.getElementById('route-info');

// Initialize maps
const mapStreets = new maplibregl.Map({container:'map-streets', style:STREETS_URL, center:savedView?.center||[0,0], zoom:savedView?.zoom??1, attributionControl:false});
const mapHybrid = new maplibregl.Map({container:'map-hybrid', style:HYBRID_URL, center:savedView?.center||[0,0], zoom:savedView?.zoom??1, attributionControl:false});

[mapStreets,mapHybrid].forEach(m=>{
  m.addControl(new maplibregl.NavigationControl({showCompass:true, showZoom:true}),'top-left');
});

// Hybrid toggle
const hybridToggleEl = document.getElementById('hybridToggle');
function showHybrid(isHybrid){
  hybridToggleEl.classList.toggle('active', isHybrid);
  document.getElementById('map-streets').style.display = isHybrid?'none':'block';
  document.getElementById('map-hybrid').style.display = isHybrid?'block':'none';
  if(isHybrid) mapHybrid.resize(); else mapStreets.resize();
  currentStyle = isHybrid?'hybrid':'streets';
  localStorage.setItem('mapStyle',currentStyle);
}
showHybrid(currentStyle==='hybrid');
hybridToggleEl.onclick = ()=>showHybrid(currentStyle==='streets');

// Sync maps on moveend
function syncView(src,tgt){ const c=src.getCenter(), z=src.getZoom(); tgt.jumpTo({center:[c.lng,c.lat],zoom:z}); }
mapStreets.on('moveend', ()=>syncView(mapStreets,mapHybrid));
mapHybrid.on('moveend', ()=>syncView(mapHybrid,mapStreets));

// Save view
function saveView(){ 
  const activeMap=currentStyle==='streets'?mapStreets:mapHybrid;
  const c=activeMap.getCenter(), z=activeMap.getZoom();
  localStorage.setItem('mapView', JSON.stringify({center:[c.lng,c.lat], zoom:z}));
}
mapStreets.on('moveend', saveView);
mapHybrid.on('moveend', saveView);

// Routing buttons
const toggleRouteBtn = document.getElementById('toggleRoute');
function updateRouteButton(){ toggleRouteBtn.textContent = routingEnabled?'Disable Routing':'Enable Routing'; }
updateRouteButton();
toggleRouteBtn.onclick = ()=>{
  routingEnabled=!routingEnabled;
  localStorage.setItem('mapRouteEnabled', routingEnabled);
  updateRouteButton();
  if(!routingEnabled) clearRoute();
};
document.getElementById('mode').onchange = ()=>{ routingMode = document.getElementById('mode').value; if(routePoints.length>=2) fetchRoute(); };
document.getElementById('resetRoute').onclick = clearRoute;
document.getElementById('locateBtn').onclick = ()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    const lngLat=[pos.coords.longitude,pos.coords.latitude];
    addSearchMarker(lngLat,'My Location');
    const activeMap=currentStyle==='streets'?mapStreets:mapHybrid;
    activeMap.flyTo({center:lngLat, zoom:14});
  });
};

// Map click adds marker
function onMapClick(e){
  if(!routingEnabled) return;
  const lngLat=[e.lngLat.lng,e.lngLat.lat];
  addMarker(lngLat);
}
[mapStreets,mapHybrid].forEach(m=>m.on('click', onMapClick));

function addMarker(lngLat){
  const activeMap = currentStyle==='streets'?mapStreets:mapHybrid;
  const m=new maplibregl.Marker({draggable:true}).setLngLat(lngLat).addTo(activeMap);
  m.on('dragend', ()=>{ const idx=markers.indexOf(m); if(idx>=0){ routePoints[idx]=[m.getLngLat().lng, m.getLngLat().lat]; if(routePoints.length>=2) fetchRoute(); }});
  markers.push(m); routePoints.push(lngLat);
  if(routePoints.length>=2) fetchRoute();
}

function addSearchMarker(lngLat, title){
  const activeMap = currentStyle==='streets'?mapStreets:mapHybrid;
  const m=new maplibregl.Marker({color:'red', draggable:true}).setLngLat(lngLat).setPopup(new maplibregl.Popup().setText(title)).addTo(activeMap);
  m.getElement().title=title;
  searchMarkers.push(m);
  m.on('dragend', ()=>{ const idx=routePoints.indexOf(routePoints[routePoints.length-1]); if(idx>=0) routePoints[idx]=[m.getLngLat().lng,m.getLngLat().lat]; if(routePoints.length>=2) fetchRoute(); });
  if(routingEnabled){ routePoints.push(lngLat); if(routePoints.length>=2) fetchRoute(); }
}

// Clear
function clearRoute(){
  markers.forEach(m=>m.remove()); markers=[];
  searchMarkers.forEach(m=>m.remove()); searchMarkers=[];
  routePoints=[]; routeInfo.style.display='none';
  [mapStreets,mapHybrid].forEach(m=>{ if(m.getLayer('route')) m.removeLayer('route'); if(m.getSource('route')) m.removeSource('route'); });
}

// Fetch route
function fetchRoute(){
  if(routePoints.length<2) return;
  fetch(`https://api.openrouteservice.org/v2/directions/${routingMode}/geojson`,{
    method:'POST',
    headers:{'Authorization':ORS_KEY,'Content-Type':'application/json'},
    body: JSON.stringify({coordinates:routePoints})
  }).then(r=>r.json()).then(data=>{
    if(!data.features || !data.features[0]) return;
    const f=data.features[0];
    const geom=f.geometry;
    const dist=(f.properties.summary.distance/1000).toFixed(2);
    const dur=Math.round(f.properties.summary.duration/60);
    routeInfo.innerHTML=`Distance: ${dist} km | Duration: ${dur} min`;
    routeInfo.style.display='block';
    [mapStreets,mapHybrid].forEach(m=>{
      if(m.getSource('route')){ m.removeLayer('route'); m.removeSource('route'); }
      m.addSource('route',{type:'geojson', data:{type:'Feature', geometry:geom}});
      m.addLayer({id:'route', type:'line', source:'route', layout:{'line-cap':'round','line-join':'round'}, paint:{'line-color':'#0074d9','line-width':5}});
    });
  });
}

// Search
const searchInput=document.getElementById('searchInput');
const searchResults=document.getElementById('searchResults');
let searchTimeout=null;
searchInput.addEventListener('input', ()=>{
  clearTimeout(searchTimeout);
  const query=searchInput.value.trim();
  if(!query){ searchResults.style.display='none'; return; }
  searchTimeout=setTimeout(()=>{
    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`)
    .then(r=>r.json()).then(data=>{
      searchResults.innerHTML='';
      if(data.length===0){ searchResults.style.display='none'; return; }
      data.forEach(place=>{
        const div=document.createElement('div'); div.textContent=place.display_name;
        div.style.padding='4px 8px'; div.style.cursor='pointer';
        div.onclick=()=>{
          const lngLat=[parseFloat(place.lon), parseFloat(place.lat)];
          const activeMap=currentStyle==='streets'?mapStreets:mapHybrid;
          activeMap.flyTo({center:lngLat, zoom:14});
          addSearchMarker(lngLat, place.display_name);
          searchInput.value=''; searchResults.style.display='none';
        };
        searchResults.appendChild(div);
      });
      searchResults.style.display='block';
    });
  },300);
});
document.addEventListener('click', e=>{ if(!document.getElementById('searchBox').contains(e.target)) searchResults.style.display='none'; });
</script>
</body>
</html>
