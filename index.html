<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<style>
html, body { margin:0; height:100%; }
#map { width:100%; height:100%; }
#toggle {
  position:absolute; top:10px; right:10px; z-index:10;
  padding:6px 10px; background:white; border:1px solid #ccc; cursor:pointer;
  font:14px sans-serif;
}
.maptiler-logo {
  position:absolute; left:10px; bottom:10px; z-index:10;
}
</style>
</head>
<body>

<div id="map"></div>
<button id="toggle">Hybrid</button>

<a class="maptiler-logo" href="https://www.maptiler.com" target="_blank" rel="noopener">
  <img src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo">
</a>

<script>
const KEY = '1xuGVLLA0XJlvXZT2dFB';

const STYLES = {
  streets: `https://api.maptiler.com/maps/019b2817-43ac-7a98-b15b-c204722a617b/style.json?key=${KEY}`,
  hybrid: `https://api.maptiler.com/maps/hybrid/style.json?key=${KEY}`
};

const STORAGE_VIEW = 'mapView';
const STORAGE_STYLE = 'mapStyle';

const savedView = JSON.parse(localStorage.getItem(STORAGE_VIEW) || 'null');
let currentStyle = localStorage.getItem(STORAGE_STYLE) || 'streets';

// Main map
const map = new maplibregl.Map({
  container: 'map',
  style: STYLES[currentStyle],
  center: savedView?.center || [0,0],
  zoom: savedView?.zoom ?? 1,
  attributionControl: false
});

// Attribution & Navigation
map.addControl(new maplibregl.AttributionControl({ compact:false }), 'bottom-right');
map.addControl(new maplibregl.NavigationControl(), 'top-left');

const toggle = document.getElementById('toggle');

// =================== Preload streets tiles ===================
const preloadMap = new maplibregl.Map({
  container: document.createElement('div'), // invisible
  style: STYLES.streets,
  center: savedView?.center || [0,0],
  zoom: savedView?.zoom ?? 1,
  interactive: false,
  preserveDrawingBuffer: false,
  attributionControl: false
});
// This map stays hidden and caches tiles

// =================== Style switch function ===================
function switchStyle(name) {
  // If switching back to streets, ensure tiles are ready
  if (name === 'streets') {
    // wait until preload map fully loaded
    if (!preloadMap.isStyleLoaded()) {
      preloadMap.once('load', () => {
        map.setStyle(STYLES.streets);
      });
    } else {
      map.setStyle(STYLES.streets);
    }
  } else {
    map.setStyle(STYLES.hybrid);
  }

  map.once('styledata', () => {
    toggle.textContent = name === 'streets' ? 'Hybrid' : 'Streets';
    currentStyle = name;
    localStorage.setItem(STORAGE_STYLE, currentStyle);
  });
}

// Initialize button text
map.on('load', () => {
  toggle.textContent = currentStyle === 'streets' ? 'Hybrid' : 'Streets';
});

// Toggle click
toggle.onclick = () => {
  const newStyle = currentStyle === 'streets' ? 'hybrid' : 'streets';
  switchStyle(newStyle);
};

// Save view
map.on('moveend', () => {
  const c = map.getCenter();
  localStorage.setItem(STORAGE_VIEW, JSON.stringify({
    center: [c.lng, c.lat],
    zoom: map.getZoom()
  }));
});
</script>

</body>
</html>
